#!/usr/bin/env ruby

require "optparse"

options = {
  file: "snapimage_config.yml",
  force: false
}

optparse = OptionParser.new do |opts|
  opts.banner = "Usage: snapimage_generate_config local_root public_url [options]"

  opts.separator ""
  opts.separator "local_root\tPath to the directory where the images will be stored"
  opts.separator "public_url\tURL at which the images will accessible from"

  opts.separator ""
  opts.separator "Options:"

  opts.on("-f", "--file FILE", "File to generate (Default: snapimage_config.yml)") do |file|
    options[:file] = file
  end

  opts.on("--force", "Overwrites the file if it exists") do
    options[:force] = true
  end

  opts.on("-h", "--help", "Display the help screen") do
    puts opts
    exit
  end
end
optparse.parse!

unless ARGV.length == 2
  puts optparse.help
  exit
end

local_root = ARGV[0]
public_url = ARGV[1]

if !options[:force] && File.exists?(options[:file])
  puts "File '#{options[:file]}' already exists. Use --force if you want to overwrite."
  puts "Config file not generated."
  puts
  puts optparse.help
  exit
end

File.open(options[:file], "w") do |f|
  f.write(<<-EOF
primary_storage_server: "local"
storage_servers:
  -
    name: "local"
    type: "LOCAL"
    local_root: "#{local_root}"
    public_url: "#{public_url}"
EOF
  )
end
puts "Config file generated at '#{options[:file]}'."
